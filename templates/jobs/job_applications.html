{% extends "base.html" %}
{% block content %}
<div class="container container-narrow mt-4">

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <h2 class="can-title">Applications ‚Äî {{ job.title }}</h2>
    <a href="{% url 'my_jobs' %}" class="can-btn-outline">‚Üê Back to My Jobs</a>
  </div>
 

  


  {% if applications %}
    <div style="display:flex;flex-direction:column;gap:16px;">
      {% for app in applications %}
        <div class="can-card can-pad" style="display:flex;flex-direction:column;gap:10px;">

          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-weight:700;">
                {{ app.freelancer.full_name|default:app.freelancer.freelancer.name }}
              </div>
              {% if app.most_recommended %}
                <div class="can-chip" style="margin-top:6px;background:rgba(255,215,0,.12);color:#ffd700;font-weight:800;">
                  üèÖ Most Recommended
                </div>
              {% endif %}
              <div class="can-muted" style="font-size:13px;">
                Applied {{ app.created_at|date:"d M, H:i" }}
                {% if app.freelancer.city or app.freelancer.country %}
                  ‚Ä¢ {{ app.freelancer.city }} {{ app.freelancer.country }}
                {% endif %}
                {% if app.expected_salary %} ‚Ä¢ ‚Çπ{{ app.expected_salary }}{% endif %}
                {% if app.availability_date %} ‚Ä¢ available {{ app.availability_date }}{% endif %}
              </div>
            </div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <a class="can-btn-outline" href="{% url 'job_application_detail' app.id %}">Open</a>

              <a class="can-btn-outline"
                 href="{% url 'recruiter_view_freelancer_profile' app.freelancer.id %}?job={{ job.id }}">
                 Profile
              </a>

              {% if app.resume_file %}
                <a class="can-btn-outline" href="{{ app.resume_file.url }}" target="_blank" rel="noopener">Resume</a>
              {% elif app.resume %}
                <a class="can-btn-outline" href="{{ app.resume.url }}" target="_blank" rel="noopener">Resume</a>
              {% endif %}
            </div>
          </div>

          {% with flow=app.flow %}
            {% if flow %}
              {% if flow.stage == "SHORTLISTED" %}
                <span class="can-badge">
                  Awaiting response ({{ flow.shortlist_expires_at|date:"d M, H:i" }})
                </span>

              {% elif flow.stage == "SHORTLISTED_ACCEPTED" %}
                <span class="can-badge">Accepted ‚Üí schedule interview</span>
                <a class="can-chip" href="{% url 'flow_recruiter_schedule_interview' app.id %}">
                  Schedule interview
                </a>

              {% elif flow.stage == "SHORTLISTED_DECLINED" %}
                <span class="can-badge">Declined</span>

              {% elif flow.stage == "SHORTLIST_EXPIRED" %}
                <span class="can-badge">Expired</span>

              {% elif flow.stage == "INTERVIEW" %}
                <span class="can-badge">Interview: {{ flow.interview_at|date:"d M, H:i" }}</span>

                {# ---- POST buttons for outcome (matches the safe view we wrote) ---- #}
                <form method="post" action="{% url 'flow_recruiter_set_outcome' app.id 'hire' %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="can-chip">Hire</button>
                </form>
                <form method="post" action="{% url 'flow_recruiter_set_outcome' app.id 'reject' %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="can-chip">Reject</button>
                </form>

              {% elif flow.stage == "HIRED" %}
                <span class="can-badge">Hired</span>

                {# ---- Recruiter-side: Add/Edit review when eligible ---- #}
                {% if app.contract and app.contract.review %}
                  <div class="can-muted">Reviewed: {{ app.contract.review.rating }}‚òÖ</div>
                  <a class="can-btn-outline" href="{% url 'application_review_edit' app.id %}">Edit review</a>
                {% else %}
                  <a class="can-btn" href="{% url 'application_review_create' app.id %}">Add review</a>
                {% endif %}

                {# (Optional) show completion chip to recruiter too #}
                {% if app.contract %}
                  {% if app.contract.is_completed %}
                    <span class="can-chip">‚úÖ Completed on {{ app.contract.completed_at|date:"d M, Y" }}</span>
                  {% else %}
                    <span class="can-chip">‚è≥ In progress</span>
                  {% endif %}
                {% endif %}

              {% elif flow.stage == "REJECTED" %}
                <span class="can-badge">Rejected</span>
              {% endif %}
            {% else %}
              <a class="can-btn" href="{% url 'flow_recruiter_shortlist' app.id %}">
                ‚≠ê Shortlist
              </a>
            {% endif %}
          {% endwith %}


          {% if app.cover_letter %}
            <div class="can-muted" style="font-size:13px;line-height:1.6;">
              {{ app.cover_letter|truncatechars:220 }}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="can-card can-pad">No applications yet.</div>
  {% endif %}
</div>
{% endblock %}

