{% extends "base.html" %}
{% block title %}AI Resume Coach{% endblock %}
{% block content %}
<div class="can-wrap container-narrow">
  <section class="can-card can-pad-lg">
    <h3 class="section-title">AI Resume Coach</h3>
    <p class="muted">Upload your resume once, then chat to improve it step by step.</p>

    <!-- Upload -->
    <form id="upload" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="file" name="file" accept=".pdf,.docx,.txt" required>
      <button class="can-btn">Load Resume</button>
    </form>

    <div id="chat" class="chat-box" style="margin-top:16px;display:none;">
      <div id="messages" style="max-height:400px;overflow-y:auto;padding:8px;background:#0f1620;border-radius:8px;"></div>
      <div style="display:flex;margin-top:8px;gap:6px;">
        <input id="msg" class="can-input" placeholder="Ask about your resume..." style="flex:1;">
        <button id="send" class="can-btn">Send</button>
      </div>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const csrftoken = document.cookie.match(/csrftoken=([^;]+)/)[1];
let resumeText = '';

document.getElementById('upload').onsubmit = async e => {
  e.preventDefault();
  const f = e.target.file.files[0];
  if(!f){ alert("Upload a resume first."); return; }
  const fd = new FormData(); fd.append('file', f);
  // use your existing extractor endpoint
  const res = await fetch("{% url 'ai:resume_analysis' %}", {method:'POST',headers:{'X-CSRFToken':csrftoken},body:fd});
  const html = await res.text();
  resumeText = html.replace(/<[^>]+>/g,'').slice(0,4000); // crude text capture
  document.getElementById('chat').style.display='block';
  document.getElementById('messages').innerHTML='<div class="bot">Resume loaded! You can now ask me what to improve.</div>';
};

document.getElementById('send').onclick = async ()=>{
  const q = document.getElementById('msg').value.trim();
  if(!q) return;
  const box=document.getElementById('messages');
  box.innerHTML += `<div class="user"><b>You:</b> ${q}</div>`;
  document.getElementById('msg').value='';
  const fd=new URLSearchParams({message:q,resume:resumeText});
  const r=await fetch("{% url 'ai:resume_chat_reply' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken},body:fd});
  const j=await r.json();
  box.innerHTML += `<div class="bot" style="margin:6px 0;">${marked.parse(j.reply)}</div>`;
  box.scrollTop = box.scrollHeight;
};
</script>
{% endblock %}
