{% extends "base.html" %}
{% load static %}

{% block title %}My Profile ‚Äî Freelancer Portal{% endblock %}

{% block content %}
<!-- <div class="can-hero"> -->
<div class="can-hero fullbleed">
  <div class="can-wrap">
    <div class="hero-inner">
      <div>
        <div class="hero-eyebrow">Welcome back</div>
        <h1 class="hero-title">{{ freelancer.name|default:"Freelancer" }}</h1>
        <div class="hero-sub">{{ profile.headline|default:"Add a short headline to stand out." }}</div>
      </div>
      <div class="hero-actions">
        <a class="pill-btn pill-teal can-btn" href="{% url 'jobs_list' %}" style=" background:linear-gradient(135deg,#34d399,#22d3ee); color:#001016;">Browse Jobs</a>
        <a class="can-btn" href="{% url 'freelancer_profile_edit' %}">Edit Profile</a>
        {% if profile.resume_file %}
          <a class="can-btn can-btn-2" href="{{ profile.resume_file.url }}" target="_blank">View Resume</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="can-wrap can-grid">
  <!-- Sidebar -->
  <aside class="can-card can-pad-lg sidebar">
    <div class="pfp">
      {% if profile.profile_photo %}
        <img src="{{ profile.profile_photo.url }}" alt="Profile photo">
      {% else %}
        <div class="pfp-fallback">üë©‚Äçüíª</div>
      {% endif %}
    </div>

    <div class="name">{{ freelancer.name }}</div>
    <div class="muted">{{ profile.headline }}</div>

    <div class="chips">
      {% if profile.work_modes %}<span class="can-chip">{{ profile.get_work_modes_display }}</span>{% endif %}
      {% if profile.location_city or profile.location_country %}
        <span class="can-chip">üìç {{ profile.location_city }} {{ profile.location_country }}</span>
      {% endif %}
      {% if profile.years_experience is not None %}
        <span class="can-chip">üéØ {{ profile.years_experience }} yrs</span>
      {% endif %}
    </div>

    <div class="kv">
      {% if profile.timezone %}<div><span>Timezone</span><b>{{ profile.timezone }}</b></div>{% endif %}
      {% if profile.hourly_rate %}<div><span>Hourly</span><b>{{ profile.hourly_rate }}</b></div>{% endif %}
      {% if profile.github_url %}<div><span>GitHub</span><a href="{{ profile.github_url }}" target="_blank">Open ‚Üí</a></div>{% endif %}
      {% if profile.portfolio_link %}<div><span>Portfolio</span><a href="{{ profile.portfolio_link }}" target="_blank">Open ‚Üí</a></div>{% endif %}
      {% if profile.publications_link %}<div><span>Publications</span><a href="{{ profile.publications_link }}" target="_blank">Open ‚Üí</a></div>{% endif %}
    </div>

    <div class="contact">
      <div class="muted small">Contact</div>
      <div class="kv">
        {% if profile.contact_email %}<div><span>Email</span><b>{{ profile.contact_email }}</b></div>{% endif %}
        {% if profile.contact_phone %}<div><span>Phone</span><b>{{ profile.contact_phone }}</b></div>{% endif %}
        {% if profile.contact_whatsapp %}<div><span>WhatsApp</span><b>{{ profile.contact_whatsapp }}</b></div>{% endif %}
      </div>
    </div>
    
</section>


  </aside>


  <!-- Main -->
  <main class="main">
    {#Invitations & Status #}
{% if my_apps %}
  {% for app in my_apps %}
    {% with flow=app.flow %}
      {% if flow %}
        {% if flow.stage == "SHORTLISTED" %}
          <section class="can-card can-pad-lg" style="margin-top:16px">
            <div class="can-title" style="font-size:18px;margin:0 0 6px;">
              Shortlisted for: {{ app.job.title }}
            </div>
            <div class="muted" style="margin-bottom:10px;">
              Please respond before <b>{{ flow.shortlist_expires_at|date:"d M, H:i" }}</b>.
            </div>
            <div class="flex" style="display:flex;gap:10px;flex-wrap:wrap;">
              <a class="can-btn" href="{% url 'flow_freelancer_respond' app.id 'accept' %}">I‚Äôm Interested</a>
              <a class="can-btn" href="{% url 'flow_freelancer_respond' app.id 'decline' %}">Not Interested</a>
              <a class="can-chip" href="{% url 'job_detail' app.job.id %}">View job ‚Üí</a>
            </div>
          </section>

        {% elif flow.stage == "INTERVIEW" %}
          <section class="can-card can-pad-lg" style="margin-top:16px">
            <div class="can-title" style="font-size:18px;margin:0 0 6px;">
              Interview scheduled: {{ app.job.title }}
            </div>
            <div class="muted" style="margin-bottom:10px;">
              When: <b>{{ flow.interview_at|date:"d M, H:i" }}</b>
              {% if flow.interview_link %}
                ¬∑ Link: <a href="{{ flow.interview_link }}" target="_blank" rel="noopener">{{ flow.interview_link }}</a>
              {% endif %}
            </div>
            {% if flow.interview_message %}
              <div class="muted">{{ flow.interview_message }}</div>
            {% endif %}
          </section>

        {% elif flow.stage == "HIRED" or flow.stage == "REJECTED" %}
          <section class="can-card can-pad-lg" style="margin-top:16px">
            <div class="can-title" style="font-size:18px;margin:0 0 6px;">
              Outcome: {{ flow.stage|title }} ‚Äî {{ app.job.title }}
            </div>

            {# >>> Add here: read-only contract badges for freelancers <<< #}
            {% if flow.stage == "HIRED" and app.contract %}
              {% if app.contract.is_completed %}
                <div class="can-chip">‚úÖ Marked completed on {{ app.contract.completed_at|date:"d M, Y" }}</div>
              {% else %}
                <div class="can-chip">‚è≥ In progress</div>
              {% endif %}
              {% if app.contract.review %}
                <div class="can-chip">‚òÖ {{ app.contract.review.rating }} ‚Äî ‚Äú{{ app.contract.review.review_text|truncatechars:80 }}‚Äù</div>
              {% endif %}
            {% endif %}

            <a class="can-chip" href="{% url 'job_detail' app.job.id %}">View job ‚Üí</a>
          </section>


        {% elif flow.stage == "SHORTLISTED_DECLINED" %}
          <section class="can-card can-pad-lg" style="margin-top:16px">
            <div class="muted">You declined the shortlist for <b>{{ app.job.title }}</b>.</div>
          </section>

        {% elif flow.stage == "SHORTLIST_EXPIRED" %}
          <section class="can-card can-pad-lg" style="margin-top:16px">
            <div class="muted">Shortlist expired for <b>{{ app.job.title }}</b>.</div>
          </section>
        {% endif %}
      {% endif %}
    {% endwith %}
  {% endfor %}
{% endif %}

    <!-- About -->
    <section class="can-card can-pad-lg">
      <h3 class="section-title">About</h3>
      <p class="muted" style="line-height:1.8">
        {{ profile.bio|default:"Tell clients what you do, what you‚Äôve shipped, and what problems you love solving." }}
      </p>
      <div class="about-grid">
        <div>
          <div class="muted small">Location</div>
          <div class="strong">{{ profile.location_city }} {{ profile.location_country }}</div>
        </div>
        <div>
          <div class="muted small">Timezone</div>
          <div class="strong">{{ profile.timezone }}</div>
        </div>
        <div>
          <div class="muted small">Experience</div>
          <div class="strong">{{ profile.years_experience }} years</div>
        </div>
        <div>
          <div class="muted small">Work Mode</div>
          <div class="strong">{{ profile.get_work_modes_display }}</div>
        </div>
      </div>
    </section>

    <!-- Roles & Skills -->
    <section class="can-card can-pad-lg">
      <h3 class="section-title">Roles & Skills</h3>
      {% if roles %}
        <div class="muted small">Primary Roles</div>
        <div class="chips" style="margin-top:8px;">
          {% for r in roles %}
            <span class="can-chip">{{ r.role.name }}</span>
          {% endfor %}
        </div>
      {% endif %}

      {% if skills %}
        <div class="muted small" style="margin-top:16px;">Top Skills</div>
        <div class="skills-grid">
          {% for s in skills %}
            <div class="skill-pill">
              <span>{{ s.skill.name }}</span>
              <em>{{ s.get_level_display }}</em>
              {% if s.years %}<b>{{ s.years }}y</b>{% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">Add your skills to get better matches.</div>
      {% endif %}

      {% if langs %}
        <div class="muted small" style="margin-top:16px;">Languages</div>
        <div class="chips" style="margin-top:8px;">
          {% for l in langs %}
            <span class="can-chip">{{ l.language.name }} ‚Ä¢ {{ l.get_proficiency_display }}</span>
          {% endfor %}
        </div>
      {% endif %}
    </section>


<!-- Browse Jobs ‚Äî CTA between sections -->
<section class="cta-card jobs-cta between-sections">
  <div class="cta-body">
    <div class="cta-icon" aria-hidden="true">
      <!-- briefcase icon -->
      <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor">
        <path d="M10 4h4a2 2 0 0 1 2 2v1h3a2 2 0 0 1 2 2v4.5a4.5 4.5 0 0 1-4.5 4.5H7.5A4.5 4.5 0 0 1 3 13.5V9a2 2 0 0 1 2-2h3V6a2 2 0 0 1 2-2Zm4 2h-4v1h4V6ZM5 11h14v1.5a2.5 2.5 0 0 1-2.5 2.5H7.5A2.5 2.5 0 0 1 5 12.5V11Z"/>
      </svg>
    </div>

    <div class="cta-copy">
      <h3>Browse Jobs</h3>
      <p>See all active roles from verified recruiters and apply in one click.</p>
    </div>
  </div>

  <a class="cta-btn" href="{% url 'jobs_list' %}">View Jobs ‚Üí</a>
</section>


    <!-- Projects timeline -->
    <section class="can-card can-pad-lg">
      <h3 class="section-title">Projects</h3>
      {% if projects %}
        <div class="timeline">
          {% for p in projects %}
            <div class="tl-item">
              <div class="tl-dot"></div>
              <div class="tl-card">
                <div class="tl-head">
                  <div class="tl-title">{{ p.title }}</div>
                  <div class="muted small">{{ p.start_date }}{% if p.end_date %} ‚Äî {{ p.end_date }}{% endif %}</div>
                </div>
                {% if p.role_title %}<div class="muted">Role: {{ p.role_title }}</div>{% endif %}
                {% if p.summary %}<p class="muted" style="margin-top:6px">{{ p.summary }}</p>{% endif %}
                {% if p.tech_list %}
                  <div class="chips" style="margin-top:8px;">
                    {% for t in p.tech_list %}
                      <span class="can-chip">{{ t }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="links">
                  {% if p.demo_url %}<a href="{{ p.demo_url }}" target="_blank" class="link">Live demo ‚Üí</a>{% endif %}
                  {% if p.repo_url %}<a href="{{ p.repo_url }}" target="_blank" class="link">Repository ‚Üí</a>{% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">Showcase 2‚Äì3 projects you‚Äôre proud of.</div>
      {% endif %}
    </section>

    <!-- Achievements & Publications -->
    <section class="can-card can-pad-lg">
      <div class="two-col">
        <div>
          <h3 class="section-title">Achievements</h3>
          {% if achievements %}
            <ul class="flat-list">
              {% for a in achievements %}
                <li>
                  <span class="dot">üèÜ</span>
                  <div>
                    <b>{{ a.title }}</b>
                    {% if a.date %}<span class="muted small"> ‚Äî {{ a.date }}</span>{% endif %}
                    {% if a.description %}<div class="muted">{{ a.description }}</div>{% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="muted">Add notable wins‚Äîawards, certifications, milestones.</div>
          {% endif %}
        </div>

        <div>
          <h3 class="section-title">Publications</h3>
          {% if publications %}
            <ul class="flat-list">
              {% for p in publications %}
                <li>
                  <span class="dot">üìù</span>
                  <div>
                    <b>{{ p.title }}</b>
                    {% if p.date %}<span class="muted small"> ‚Äî {{ p.date }}</span>{% endif %}
                    {% if p.link %}<div><a href="{{ p.link }}" class="link" target="_blank">Read ‚Üí</a></div>{% endif %}
                    {% if p.description %}<div class="muted">{{ p.description }}</div>{% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="muted">Publish posts or talks? List them here.</div>
          {% endif %}
        </div>
      </div>
    </section>
  <section class="can-card can-pad" style="margin-top:18px;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <div>
      <div class="can-title" style="margin-bottom:2px;">AI Profile Assistant</div>
      <div class="can-muted">Get suggestions & generate a one-page resume draft.</div>
    </div>
    <div style="display:flex;gap:8px;">
      <!-- <a class="can-btn" href="{% url 'ai:resume_form' %}">Analyze profile</button> -->
      <a class="can-btn" href="{% url 'ai:resume_form' %}">Generate resume</a>
    </div>
  </div>
  <div id="ai-output" class="can-card can-pad" style="margin-top:12px; display:none;"></div>
</section>
<!-- 
<a class="can-btn" href="{% url 'ai:resume_chat' %}"
   style="background:linear-gradient(135deg,#34d399,#22d3ee);color:#001016;">
  üí¨ Chat with AI Resume Coach
</a>

<form id="resume-upload-form" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="file" name="resume" id="resume-input" accept=".pdf,.docx,.txt">
  <button type="button" id="btn-upload-analyze" class="can-btn">Analyze My Resume</button>
</form>

<div id="ai-upload-output" class="can-card can-pad" style="display:none;"></div> -->

<a class="can-btn-outline" href="{% url 'resume_ai:suggest' %}">
  Analyze my resume (AI)
</a>


  </main>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- helpers ----------
  const $ = (sel) => document.querySelector(sel);

  // read csrftoken from cookie (Django default)
  function getCSRF() {
    const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : '';
  }

  // show HTML in a block
  function showIn(el, html) {
    el.style.display = 'block';
    el.innerHTML = html;
  }

  // small POST helper for x-www-form-urlencoded
  async function postForm(url, dataObj) {
    const body = new URLSearchParams(dataObj);
    const res  = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'fetch',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
      },
      body
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  // ---------- Generate Resume (Markdown) ----------
  const out = $('#ai-output');
  const btnGen = $('#btn-ai-resume');

  if (btnGen && out) {
    btnGen.onclick = async () => {
      showIn(out, 'Generating resume ‚Ä¶');
      try {
        const r = await postForm("{% url 'ai:ai_generate_resume' %}", {}); // expects { ok, markdown }
        showIn(out, `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <h4 class="can-title" style="margin:0;">Resume (Markdown)</h4>
            <div style="display:flex;gap:8px;">
              <button id="btn-copy"  class="can-btn-outline">Copy</button>
              <button id="btn-dl-md" class="can-btn-outline">Download .md</button>
              <a class="can-btn-outline" href="{% url 'ai:ai_resume_preview' %}" target="_blank">Download PDF</a>
            </div>
          </div>
          <pre id="md" style="white-space:pre-wrap;margin-top:10px;">${r.markdown || '(empty)'}</pre>
        `);

        // copy
        const copyBtn = $('#btn-copy');
        copyBtn.onclick = async () => {
          await navigator.clipboard.writeText($('#md').innerText);
          copyBtn.textContent = 'Copied!';
          setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
        };

        // download .md
        const dlBtn = $('#btn-dl-md');
        dlBtn.onclick = () => {
          const md = $('#md').innerText;
          const blob = new Blob([md], { type: 'text/markdown' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'resume.md';
          a.click();
          setTimeout(() => URL.revokeObjectURL(a.href), 500);
        };
      } catch (e) {
        showIn(out, `<div class="can-error">Error: ${e.message}</div>`);
      }
    };
  }

  // ---------- Analyze Uploaded Resume (Gemini) ----------
  const btnAnalyze = $('#btn-upload-analyze');
  const form       = $('#resume-upload-form');
  const outUpload  = $('#ai-upload-output');

  if (btnAnalyze && form && outUpload) {
    btnAnalyze.onclick = async () => {
      try {
        const fileInput = $('#resume-input');
        if (!fileInput || !fileInput.files[0]) {
          alert('Please choose a resume file (.pdf, .docx, .txt).');
          return;
        }

        const formData = new FormData(form); // includes 'resume' + csrf token (thanks to {% csrf_token %})
        showIn(outUpload, 'Analyzing‚Ä¶');

        const res = await fetch("{% url 'ai:ai_analyze_uploaded_resume' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': getCSRF(), 'X-Requested-With': 'fetch' },
          body: formData
        });

        if (!res.ok) {
          const txt = await res.text();
          showIn(outUpload, `<div class="can-error">Request failed (${res.status}). ${txt}</div>`);
          return;
        }

        const data = await res.json();
        showIn(outUpload, data.ok
          ? (data.feedback || 'No feedback returned.')
          : `<div class="can-error">${data.error || 'Unknown error'}</div>`
        );
      } catch (e) {
        showIn(outUpload, `<div class="can-error">Error: ${e.message}</div>`);
        console.error(e);
      }
    };
  } else {
    console.warn('Analyze widgets not found: make sure #resume-upload-form, #resume-input, #btn-upload-analyze, #ai-upload-output exist.');
  }
});
</script>




{% endblock %}
